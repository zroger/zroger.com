$:.unshift(File.expand_path("../lib", __FILE__))
require 'rake-pipeline-web-filters'
require 'zroger/rake-pipeline/resize_filter'

output "assets"

input "_assets" do
  match "css/*.less" do
    less
  end

  js = [
    "vendor/bootstrap/js/bootstrap-modal.js",
    "vendor/google-code-prettify/prettify.js",
    "js/all.js"
  ]
  js_pattern = Regexp.new("(" + js.collect{|x| Regexp.escape(x)}.join('|') + ")")

  match js_pattern do
    concat js, "js/all.js"
    uglify
  end

  match "vendor/bootstrap/img/*" do
    copy do |input|
      directory = File.dirname(input)
      "img/#{File.basename(input)}"
    end
  end

  # First create a copy for each resizing preset.
  match "photos/*.jpg" do
    copy do |input|
      ["teaser", "content"].collect do |x|
        File.join("photos", x, File.basename(input))
      end
    end
  end

  match "photos/teaser/*.jpg" do
    resize_image 724, 320, :method => "resize_to_fill"
  end

  match "photos/content/*.jpg" do
    resize_image 724, '', :method => "resize_to_fit"
  end
end

